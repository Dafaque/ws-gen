// Code generated by wsgen. DO NOT EDIT.
package mapper


import (
    "context"
	"errors"

    "github.com/Dafaque/ws-gen/examples/generated/model"
    "github.com/Dafaque/ws-gen/examples/generated/iface"
    "github.com/Dafaque/ws-gen/examples/generated/api"

    "github.com/gorilla/websocket" 
)

type Handler interface {
    GetConn() *websocket.Conn
    GetContext() context.Context
    GetHandler() api.MessageHandler
    GetCoder() iface.Coder
    GetLogger() iface.Logger
	CloseHandler(int, string) error
}

func Read(h Handler) error {
    _, data, errRead := h.GetConn().ReadMessage()
    if wsErr, casted := errRead.(*websocket.CloseError); casted {
		return h.CloseHandler(wsErr.Code, wsErr.Text)
	}
    if errRead != nil {
        h.GetLogger().Printf("Read(): %v", errRead)
        return errRead
    }
    var msgMeta model.WSMessageMeta
    if errUnmarshal := h.GetCoder().Unmarshal(data, &msgMeta); errUnmarshal != nil {
        h.GetLogger().Printf("Read(): %v", errUnmarshal)
        return errUnmarshal
    }
    switch msgMeta.MsgIdx {
    case model.MsgIdxTextMessage:
        var message model.TextMessage
        if err := h.GetCoder().Unmarshal(data, &message); err != nil {
            h.GetLogger().Printf("Read(): %v", err)
            return err
        }
        errHandle := h.GetHandler().OnTextMessage(
            h.GetContext(),
            message,
            api.NewMessageSender(h.GetConn(), h.GetCoder()),
        )
        if errHandle != nil {
            h.GetLogger().Printf("Read()::OnTextMessage: %v", errHandle)
            return errHandle
        }
    case model.MsgIdxChatEvent:
        var message model.ChatEvent
        if err := h.GetCoder().Unmarshal(data, &message); err != nil {
            h.GetLogger().Printf("Read(): %v", err)
            return err
        }
        errHandle := h.GetHandler().OnChatEvent(
            h.GetContext(),
            message,
            api.NewMessageSender(h.GetConn(), h.GetCoder()),
        )
        if errHandle != nil {
            h.GetLogger().Printf("Read()::OnChatEvent: %v", errHandle)
            return errHandle
        }
    default:
        err := errors.New("recieved malformed message") 
        h.GetLogger().Printf("Read()::default: %v", err)
        return err
    }
    return nil
    
}